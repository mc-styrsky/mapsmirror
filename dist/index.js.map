{
  "version": 3,
  "sources": ["../src/index.ts", "../src/extractProperties.ts"],
  "sourcesContent": ["import express from 'express';\nimport { createWriteStream } from 'fs';\nimport { mkdir, stat } from 'fs/promises';\nimport fetch from 'node-fetch';\nimport { extractProperties } from './extractProperties';\n\nconst pwd = '/home/sty/Documents/GitHub/mapsmirror';\n\n\nconst port = 3000;\n\nexpress()\n.use(express.json())\n.use(express.urlencoded({ extended: true }))\n.use('', express.static('public'))\n.get('/tile/:provider/:zoom/:x/:y', async (req, res) => {\n  try {\n    const { zoom } = extractProperties(req.params, {\n      zoom: val => parseInt(String(val)),\n    });\n    const max = 1 << zoom;\n    const parsePosition = (val) => {\n      const ret = parseInt(String(val), 16) % max;\n      return ret < 0 ? ret + max : ret;\n    };\n    const { provider, x, y } = extractProperties(req.params, {\n      provider: String,\n      x: parsePosition,\n      y: parsePosition,\n    });\n    const { quiet, ttl } = extractProperties(req.query, {\n      quiet: val => Boolean(parseInt(String(val ?? 0))),\n      ttl: val => parseInt(String(val ?? 3)),\n    });\n\n    const url = {\n      osm: `https://tile.openstreetmap.org/${zoom}/${x}/${y}.png`,\n    }[provider] ?? 'http://localhost:3000';\n    const length = 1 + (zoom >> 2);\n    const pathX = x.toString(16).padStart(length, '0').split('');\n    const pathY = y.toString(16).padStart(length, '0').split('');\n\n\n    const file = `${pathX.pop()}${pathY.pop()}.png`;\n    const path = `tiles/${provider}/${zoom.toString(36)}/${pathX.map((_val, idx) => pathX[idx] + pathY[idx]).join('/')}`;\n    await mkdir(path, { recursive: true });\n    const filename = `${pwd}/${path}/${file}`;\n\n    const fileStats = await stat(filename).catch(() => null);\n    if (fileStats && fileStats.isFile() && fileStats.size > 100) {\n      if (!quiet) console.log('[cached]', filename);\n      res.sendFile(filename);\n    }\n    else {\n      const timeoutController = new globalThis.AbortController();\n      const timeoutTimeout = setTimeout(() => timeoutController.abort(), 10000);\n\n\n      const writeImageStream = createWriteStream(filename);\n      writeImageStream.addListener('finish', () => {\n        if (!quiet) console.log('[send]  ', filename);\n        res.sendFile(filename);\n      });\n\n      console.log('[get]   ', filename);\n      try {\n        const imageStream = await fetch(url, { signal: timeoutController.signal })\n        .then((response) => response.body)\n        .catch(() => {\n          res.status(500).json({\n            length,\n            pathX,\n            pathY,\n            provider,\n            url,\n          });\n        });\n\n        if (imageStream) imageStream.pipe(writeImageStream);\n      }\n      catch { /* empty */ }\n      clearTimeout(timeoutTimeout);\n    }\n    if (ttl > 0) {\n      const fetchTile = (dx: number, dy: number) => {\n        const url = `http://localhost:${port}/tile/${provider}/${zoom + 1}/${x * 2 + dx}/${y * 2 + dy}?ttl=${ttl - 1}&quiet=1`;\n        return fetch(url).catch(() => console.log('[failed]', url));\n      };\n      fetchTile(0, 0);\n      fetchTile(0, 1);\n      fetchTile(1, 0);\n      fetchTile(1, 1);\n    }\n  }\n  catch (e) {\n    console.error(e);\n    res.status(500).send('internal server error');\n  }\n})\n.listen(port, () => console.log(`backend listener running on port ${port}`))\n.on('error', (e) => {\n  console.error(`cannot start listener on port ${port}`);\n  console.log(e);\n});\n", "export function extractProperties<T extends object> (\n  obj: Record<string, any>,\n  builder: { [P in keyof T]: (val?: any) => T[P] },\n): T {\n  return Object.entries(builder).reduce((ret, entry) => {\n    const [key, constructor]: [string, any] = entry;\n    ret[key] = constructor(obj[key]);\n    return ret;\n  }, {} as T);\n}\n"],
  "mappings": "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",
  "names": ["url"]
}
